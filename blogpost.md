<style>
table,
th,
td {
    border: 1px solid black;
    border-collapse: collapse;
}
</style>

### Structure of this Article
- [Introduction](#introduction)
  - [Scope](#scope)
  - [Not in scope](#not-in-scope)

- [Concept: How does Azure meter network incurred costs](#concept-how-does-azure-meter-network-incurred-costs)
  - [Bandwidth](#bandwidth)
  - [Virtual Network](#virtual-network)
  - [Express Route](#express-route)
  - [Firewall](#firewall)
  - [Virtual WAN](#virtual-wan)

- [Billing Scenarios](#billing-scenarios)
  - [VM / AKS / VNET enabled service to Internet](#vm-internet)


- [Conclusion](#conclusion)

- [Annex - How to access cost management in Azure](#how-to-access-cost-management-in-azure)
  - GUI
  - Cost Management API
  - AZ CLI
  - Powershell

# Introduction 

Cost Management in Azure can be a straight forward topic. Assuming there is  a resource with a fixed cost billed for the resource instance and some dynamic cost component which occurs based on the usage.

When it comes to network costs the situation gets confusing. Data transfer over the network is included in nearly all Azure operations. But not all  traffic is billed.

When you skim the documentation for this topic it is mostly pointed out that incoming traffic is free and Azure outgoing traffic costs 0.036 ‚Ç¨/GB (at the time of creation) with 100GB free monthly.

Unfortunately it gets way more complex once you look into the details. This blog article shall make some of the details easier to understand. 

# Scope

This article covers regional and multi regional scenarios taking place in one Zone (Zone 1).

# Not in scope

When it comes to intercontinental traffic the cost structure is even more complex. This is not a part of this article though

# Concept: How does Azure meter network incurred costs

There are two types of network related costs. <a href="https://azure.microsoft.com/en-us/pricing/details/virtual-network/">vNet Peering</a> / <a href="https://azure.microsoft.com/en-us/pricing/details/bandwidth/?cdn=disable">Bandwidth charges</a> and Data processed charges.


Network transfer costs arise whereever your traffic traverses parts of the azure infrastructure. So one request can generate network-based costs in various places. 

In the subsequent chapters scenarios are described that shall help to identify when
which type of network related costs are triggered.

Microsoft published a network pricing   overview which is based on a virtualWan enabled network  <a href="https://learn.microsoft.com/en-us/azure/virtual-wan/pricing-concepts">here</a>.



## Service Bandwidth

Bandwidth describes the traffic leaving the regional Azure premises or the traffic routed
to the Internet.

The service name "Bandwidth" consists of following meter subcategories

 * Outbound Data Transfer (Internet egress)
   - "Rtn Preference: MGN"  -> uses Microsoft global network - billed per GB
   - "Rtn Preference: ISP"  -> uses your ISPs breakout - billed per GB, slightly cheaper

 * Bandwidth Inter-Region , Data transfers between different Azure regions ( traffic that stays in the azure premises)

 The charges are then billed under one of the following meters 
  - Standard Data Transfer Out
  - Intra Continent Data Transfer Out
  - Inter Continent Data Transfer Out - NAM or EU To Any
  - Standard Data Transfer In (usually free)
  

## Service Virtual Network

‚ö†Ô∏è Do not confuse the service "Virtual Network" with the resource Virtual Network. The costs for the service virtual network are assigned to each resource that generate them. (VMs, VM Scale Sets, AKS)

Virtual Networks are free so you will never find them in your cost analysis. All network related costs are assigned to the resources and services that generate them.

Meter Subcategory: **Virtual Network Peering**

In this subcategory you will find the traffic costs generated by VMs accessing Services though the vNet

* Intra-Region Ingress
* Intra-Region Egress


Meter Subcategory **Virtual Network-Private Link**

All costs generated by private endpoints will be gathered in this subcategory

* Standard Private Endpoint
* Standard Data Processed Egress
* Standard Data Processed Ingress

Note: A private endpoint allows a Platform-as-a-Service (PaaS) resource to be accessed from within a virtual network, instead of the public internet. 
<a href="https://learn.microsoft.com/en-us/azure/private-link/private-endpoint-overview">Further Reading on private endpoint</a>

## Service Express Route

Meter Subcategory

In this article we assume a metered Express Route of sku standard, which has costs of the following subcategories:

* Standard Metered Data  - Fixed costs for the Express Route provisioning / month
* Metered Data - Data Transfer Out - Billed / GB
* Data Transfer In - Usually Free

## Service vWan, Firewall, Application Gateway, Loadbalancer

These are all network related ressources which costs are 
connected to the amount of traffic they process. No matter if its ingress or egress. 

# Billing Scenarios

## VM to Internet over Azure Firewall

A VM accesses a service that is provided by the internet.

# ![scenario1](scenario1-network-costs.drawio.png)

(1)
A VM generates Traffic (In this example 1TB of traffic is sent) The traffic is routed via the virtual network peering
to the vNet in which the firewall resides.

(Important) In this scenario the traffic is routed via the existing vNet Peering (the red line). It is not routed via the vWWan Hub in this scenario.

Then it enters the vNet (2) and the data is processed by the firewall(3)

(4)
The traffic egresses to the internet via the firewall by traversing the Microsoft Global Network  in this case (Routing Preference: MGN) 

Cost breakdown for this scenario #1

|Waypoint | Amount billed| Cost descrtiption
------------|-----------|-------|
1.| 18,00 ‚Ç¨ | VNET Peering Egress
2.| 18,00 ‚Ç¨ | VNET Peering Ingress
3.| 14,40 ‚Ç¨ | Firewall Data Processed
4.| 68,81 ‚Ç¨ | Bandwidth Internet Egress "Rtn Preference: MGN"
-- | **119,21** | Total Cost for 1TB (1024 GB)

## VM to a private endpoint enabled PaaS

A VM accesses a private endpoint enabled storage account (can be any private endpoint enabled service like data base, key vault, cache, etc.).

# ![scenario2](scenario2-network-costs.drawio.png)

(1)
The traffic is routed through the vHub vNet-Link  to the vHub.
(2)
The vHub processes (routes) the traffic.
(3) 
The traffic leaves the vHub to the Ressource via the vNet Link Peering.
(4) 
The request then reaches the network interface of the private Link enabled PaaS.

Cost Breakdown for Scenario #2

|Waypoint | Amount billed| Cost description
------------|-----------|-------|
1.| 9,06 ‚Ç¨ | vNet Link Peering Egress / Ingress
2.| 18,12 ‚Ç¨ | vHub Processing
3.| 9,06 ‚Ç¨ | vNet Link Peering Ingress / Egress
4.|  8,85 ‚Ç¨ | private Endpoint processing costs (outbound/inbound) 
-- | **63,21** | Total Cost for 1TB (1024 GB)


## On-Premises VM to an Azure VM that is in the backend pool of a load balancer in another region

A VM on premises accesses a service through  an ExpressRoute that  is behind a load balancer. 

# ![scenario3](scenario3-network-costs.drawio.png)


(1) Traffic entering Azure through the express Route is not billed.

Note: It is likely though that the ISP provising the link for the ExpressRoute will charge traffic fees.

(2)
The traffic is then routed through the regional vHub where it gets processed which incurs costs.

(3) The traffic is routed to the vWan Hub in the destination region through the microsoft 
backbone which is billed accordingly.

(4)
The ingressing traffic is billed again in the destination vNet in which the lb and the vm reside.

(5) finally the standard loadbalancer will process the traffic accoring to the configured
loadbalancing rules which generates costs.


|Waypoint | Amount billed| Cost description
------------|-----------|-------|
1.| 0,00 ‚Ç¨ | ingress trafic enetering Azure free, might be subject to Internet provider billing
2.| 18,12 ‚Ç¨ | vHub Processing
3.| 18,03 ‚Ç¨ | Bandwidth Inter Region, Intra Continent Data Transfer Out
4.| 9,06 ‚Ç¨ | vNet Link Peering Ingress
5.|  4,53 ‚Ç¨ | LB, SKU Standard Data Processed
-- | **49,74** | Total Cost for 1TB (1024 GB)

## Conclusion

It makes sense to evaluate different network designs with a focus on costs. 

üîÑ It might be feasible to place  components that are needed to offer one service (eg, frontend vm, database , application gateway)  in one vnet. There will be significantly less network induced costs than when they are all distributed in different vNets or even regions.


üîÑ The use of a virtual WAN can reduce costs as it combines a hub and spoke architecture with a full mesh. 
Since it has a centralized management it can reduce the complexity and amount of resources deployed in order to maintain such a design manually.

Minimize Data Transfer Costs:

‚úÖ Keep resources within the same region to avoid data transfer fees.

‚úÖ Monitor network traffic and the processing load of network related ressources.

‚ùå  Do not overprovision infrastrucutre components as virtual wan hubs, express routes or application gateways.

## Annex

AZ CLI billing / consumption & reservations
https://learn.microsoft.com/en-us/cli/azure/service-page/cost%20management?view=azure-cli-latest

Powershell costmanagement, billing and reservations module

https://learn.microsoft.com/en-us/powershell/module/az.billing/?view=azps-14.1.0

https://learn.microsoft.com/en-us/powershell/module/az.costmanagement/?view=azps-14.1.0#cost-management


https://learn.microsoft.com/en-us/powershell/module/az.reservations/?view=azps-14.1.0

Azure REST APIs for Cost Management, Billing and Consumption

https://learn.microsoft.com/en-us/rest/api/cost-management/
https://learn.microsoft.com/en-us/rest/api/billing/
https://learn.microsoft.com/en-us/rest/api/consumption/